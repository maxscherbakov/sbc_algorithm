use std::cmp::min;
use Action::*;

pub(crate) enum Action {
    Del,
    Add,
    Rep,
}

pub(crate) fn encode(data_chunk: &[u8], data_chunk_parent: &[u8]) -> Vec<u32> {
    let matrix = levenshtein_matrix(data_chunk, data_chunk_parent);
    let mut delta_code = Vec::new();
    let mut x = data_chunk.len();
    let mut y = data_chunk_parent.len();
    while x > 0 && y > 0 {
        if (data_chunk_parent[y - 1] != data_chunk[x - 1]) && (matrix[y - 1][x - 1] < matrix[y][x])
        {
            delta_code.push(encode_delta_action(Rep, y - 1, data_chunk[x - 1]));
            x -= 1;
            y -= 1;
        } else if matrix[y - 1][x] < matrix[y][x] {
            delta_code.push(encode_delta_action(Del, y - 1, 0));
            y -= 1;
        } else if matrix[y][x - 1] < matrix[y][x] {
            delta_code.push(encode_delta_action(Add, y, data_chunk[x - 1]));
            x -= 1;
        } else {
            x -= 1;
            y -= 1;
        }
    }
    while x > 0 && matrix[y][x - 1] < matrix[y][x] {
        delta_code.push(encode_delta_action(Add, y, data_chunk[x - 1]));
        x -= 1;
    }

    while y > 0 && matrix[y - 1][x] < matrix[y][x] {
        delta_code.push(encode_delta_action(Del, y - 1, 0));
        y -= 1;
    }

    delta_code
}

pub(crate) fn levenshtein_distance(data_chunk: &[u8], data_chunk_parent: &[u8]) -> u32 {
    let levenshtein_matrix = levenshtein_matrix(data_chunk, data_chunk_parent);
    levenshtein_matrix[data_chunk_parent.len()][data_chunk.len()]
}

pub(crate) fn levenshtein_matrix(data_chunk: &[u8], data_chunk_parent: &[u8]) -> Vec<Vec<u32>> {
    let mut levenshtein_matrix =
        vec![vec![0u32; data_chunk.len() + 1]; data_chunk_parent.len() + 1];
    levenshtein_matrix[0] = (0..data_chunk.len() as u32 + 1).collect();
    for y in 1..data_chunk_parent.len() + 1 {
        levenshtein_matrix[y][0] = y as u32;
        for x in 1..data_chunk.len() + 1 {
            let add = levenshtein_matrix[y - 1][x] + 1;
            let del = levenshtein_matrix[y][x - 1] + 1;
            let mut replace = levenshtein_matrix[y - 1][x - 1];
            if data_chunk_parent[y - 1] != data_chunk[x - 1] {
                replace += 1;
            }
            levenshtein_matrix[y][x] = min(min(del, add), replace);
        }
    }
    levenshtein_matrix
}

fn encode_delta_action(action: Action, index: usize, byte_value: u8) -> u32 {
    let mut code = 0u32;
    match action {
        Del => {
            code += 1 << 31;
        }
        Add => {
            code += 1 << 30;
        }
        Rep => {}
    }
    code += byte_value as u32 * (1 << 22);
    if index >= (1 << 22) {
        panic!()
    }
    code += index as u32;
    code
}


#[cfg(test)]
mod test {
    use crate::levenshtein_functions;
    use chunkfs::{Database};
    use crate::levenshtein_functions::Action;

    const PATH: &str = "runner/files/test1.txt";

    #[test]
    fn test_chunk_recovery() {
        let parent_chunk_data = vec![208u8, 10, 209, 231, 106, ]; //11, 0, 91, 47, 251, 176, 255, 205, 9, 133, 241, 99, 199, 99, 53, 179, 30, 181, 160, 236, 9, 39, 97, 135, 189, 116, 145, 93, 221, 182, 65, 183, 104, 235, 72, 45, 204, 191, 10, 171, 222, 219, 152, 62, 6, 247, 199, 88, 125, 35, 119, 147, 62, 38, 57, 58, 19, 61, 189, 88, 7, 251, 84, 153, 25, 6, 90, 144, 194, 135, 234, 190, 113, 209, 208, 58, 157, 16, 10, 86, 250, 98, 93, 207, 129, 150, 76, 94, 56, 52, 118, 204, 98, 123, 148, 71, 110, 4, 98, 98, 29, 215, 126, 95, 169, 54, 156, 150, 149, 124, 174, 249, 168, 161, 76, 225, 244, 173, 182, 150, 225, 139, 107, 211, 191, 201, 161, 198, 75, 107, 107, 81, 130, 167, 183, 213, 216, 238, 242, 25, 35, 30, 53, 159, 167, 60, 148, 1, 84, 16, 54, 216, 251, 103, 97, 249, 227, 113, 143, 14, 16, 231, 162, 71, 122, 198, 70, 81, 65, 135, 23, 180, 95, 32, 53, 95, 83, 234, 123, 3, 158, 55, 164, 14, 238, 36, 239, 58, 154, 48, 0, 152, 242, 94, 23, 38, 230, 111, 219, 113, 163, 17, 61, 58, 47, 105, 64, 72, 190, 253, 39, 187, 9, 124, 53, 63, 111, 153, 7, 48, 193, 215, 178, 51, 80, 230, 216, 196, 18, 73, 84, 29, 191, 102, 191, 43, 14, 217, 30, 158, 130, 159, 38, 29, 53, 73, 87, 130, 98, 83, 29, 13, 24, 41, 62, 215, 234, 226, 187, 195, 104, 17, 173, 251, 54, 204, 13, 249, 238, 57, 163, 40, 151, 106, 5, 232, 162, 48, 41, 160, 26, 199, 121, 72, 53, 102, 191, 22, 71, 104, 17, 200, 36, 9, 43, 169, 100, 72, 164, 186, 118, 199, 24, 106, 5, 113, 162, 55, 81, 7, 26, 113, 244, 61, 65, 237, 141, 116, 23, 194, 90, 117, 43, 174, 34, 95, 102, 243, 224, 190, 128, 72, 25, 102, 131, 94, 82, 4, 113, 87, 178, 199, 99, 160, 147, 137, 208, 19, 82, 29, 35, 67, 20, 180, 124, 164, 18, 73, 7, 118, 254, 25, 197, 225, 79, 36, 176, 103, 80, 23, 123, 68, 166, 89, 210, 156, 80, 200, 70, 173, 170, 184, 5, 108, 181, 164, 236, 178, 146, 108, 63, 239, 166, 245, 141, 136, 45, 179, 183, 83, 162, 18, 54, 91, 165, 126, 242, 202, 157, 170, 133, 35, 113, 7, 131, 141, 9, 15, 95, 253, 161, 14, 92, 127, 2, 186, 165, 133, 23, 250, 177, 107, 48, 32, 202, 69, 143, 48, 128, 87, 77, 81, 96, 30, 231, 185, 40, 78, 174, 44, 126, 64, 93, 188, 201, 38, 46, 148, 219, 172, 96, 72, 4, 73, 125, 25, 191, 138, 148, 65, 209, 143, 99, 215, 165, 154, 183, 2, 6, 125, 126, 145, 45, 234, 64, 247, 139, 235, 71, 135, 70, 36, 233, 93, 43, 83, 55, 222, 155, 41, 134, 61, 46, 32, 42, 103, 101, 238, 213, 248, 42, 28, 131, 100, 153, 247, 40, 129, 57, 187, 254, 235, 21, 3, 242, 78, 145, 191, 9, 102, 67, 168, 181, 33, 64, 167, 209, 13, 194, 143, 43, 178, 124, 81, 150, 84, 70, 225, 159, 98, 123, 80, 224, 104, 129, 55, 70, 79, 158, 132, 221, 166, 28, 88, 62, 219, 37, 204, 163, 56, 120, 101, 48, 155, 22, 186, 34, 83, 131, 36, 116, 203, 121, 47, 80, 50, 72, 97, 87, 151, 122, 245, 109, 146, 216, 110, 251, 0, 13, 105, 84, 111, 108, 219, 131, 200, 77, 129, 160, 107, 206, 31, 90, 206, 253, 23, 152, 252, 121, 218, 35, 216, 185, 71, 226, 159, 188, 196, 241, 251, 178, 105, 199, 66, 113, 170, 27, 42, 84, 214, 238, 200, 133, 177, 119, 11, 37, 14, 190, 226, 162, 227, 68, 181, 84, 69, 41, 46, 16, 198, 51, 176, 21, 53, 166, 2, 189, 174, 118, 214, 157, 13, 143, 56, 6, 78, 250, 205, 163, 6, 241, 0, 232, 33, 110, 203, 38, 102, 20, 216, 132, 185, 159, 20, 11, 222, 38, 171, 58, 231, 60, 162, 171, 75, 6, 234, 226, 89, 107, 128, 52, 145, 215, 122, 131, 220, 57, 182, 47, 231, 223, 45, 144, 243, 120, 74, 219, 191, 152, 89, 55, 183, 132, 4, 205, 136, 200, 177, 187, 232, 162, 44, 157, 26, 239, 74, 34, 79, 160, 217, 152, 194, 54, 159, 156, 15, 13, 76, 240, 103, 134, 177, 156, 8, 96, 65, 102, 36, 228, 68, 247, 194, 152, 106, 233, 49, 92, 176, 249, 101, 52, 95, 74, 86, 99, 207, 118, 148, 191, 182, 0, 71, 27, 197, 126, 24, 156, 26, 167, 33, 11, 143, 19, 156, 98, 225, 194, 225, 198, 250, 5, 253, 9, 124, 37, 170, 116, 253, 197, 60, 8, 79, 143, 233, 146, 141, 158, 3, 117, 204, 164, 229, 46, 41, 0, 117, 134, 175, 147, 108, 72, 154, 41, 224, 64, 41, 207, 219, 19, 228, 5, 2, 57, 246, 134, 35, 226, 248, 88, 138, 161, 120, 120, 237, 134, 249, 93, 157, 57, 74, 188, 97, 162, 150, 211, 241, 120, 183, 185, 9, 150, 57, 67, 68, 149, 156, 146, 117, 161, 177, 148, 159, 6, 216, 35, 253, 123, 89, 104, 195, 102, 235, 189, 177, 19, 90, 37, 92, 70, 252, 189, 53, 48, 158, 172, 143, 50, 170, 54, 49, 226, 48, 177, 189, 238, 12, 222, 203, 205, 59, 200, 252, 183, 128, 226, 158, 40, 207, 19, 139, 227, 166, 27, 215, 193, 197, 23, 220, 233, 126, 217, 207, 186, 24, 171, 35, 181, 213, 69, 142, 88, 130, 81, 249, 85, 223, 22, 236, 248, 69, 171, 238, 179, 84, 159, 31, 82, 244, 33, 114, 144, 50, 217, 193, 9, 91, 39, 47, 27, 114, 138, 147, 37, 136, 54, 136, 136, 214, 157, 31, 237, 70, 255, 37, 36, 175, 148, 225, 182, 39, 253, 198, 124, 40, 176, 133, 217, 198, 192, 83, 156, 130, 56, 134, 171, 162, 72, 19, 80, 84, 238, 154, 212, 8, 72, 98, 201, 152, 106, 175, 153, 116, 114, 95, 56, 94, 167, 142, 89, 12, 227, 45, 220, 239, 207, 209, 34, 0, 122, 59, 139, 211, 178, 20, 40, 120, 176, 179, 11, 175, 253, 6, 143, 115, 44, 96, 159, 19, 46, 106, 33, 202, 40, 19, 234, 77, 80, 134, 145, 127, 187, 89, 82, 121, 79, 86, 181, 140, 93, 104, 167, 80, 214, 224, 102, 141, 169, 159, 2, 15, 239, 73, 227, 161, 7, 244, 127, 242, 144, 189, 24, 158, 108, 216, 56, 16, 106, 97, 22, 140, 49, 20, 130, 220, 188, 37, 152, 223, 213, 54, 71, 34, 124, 93, 175, 146, 194, 231, 64, 137, 28, 247, 52, 110, 118, 184, 55, 116, 163, 41, 162, 103, 180, 11, 74, 3, 68, 110, 94, 175, 197, 195, 177, 255, 125, 239, 214, 190, 44, 62, 146, 244, 116, 231, 7, 151, 217, 211, 172, 213, 225, 123, 192, 22, 200, 188, 183, 95, 8, 234, 18, 235, 112, 153, 207, 160, 184, 142, 98, 145, 73, 247, 146, 251, 27, 13, 250, 131, 237, 107, 242, 208, 10, 70, 66, 233, 180, 159, 138, 23, 195, 63, 56, 245, 254, 23, 162, 135, 184, 111, 116, 95, 211, 118, 27, 48, 157, 181, 30, 115, 89, 243, 114, 11, 217, 205, 173, 203, 207, 62, 108, 248, 24, 250, 226, 232, 183, 169, 72, 73, 156, 216, 104, 223, 61, 203, 208, 38, 79, 15, 75, 127, 72, 141, 183, 198, 91, 134, 151, 144, 58, 186, 216, 103, 3, 254, 32, 254, 173, 196, 17, 132, 171, 72, 191, 104, 76, 233, 227, 255, 181, 226, 142, 2, 137, 223, 29, 70, 250, 103, 136, 184, 120, 106, 10, 217, 145, 152, 178, 221, 200, 74, 65, 43, 236, 200, 2, 99, 41, 252, 195, 64, 69, 120, 171, 48, 238, 164, 216, 138, 73, 12, 86, 182, 60, 141, 100, 21, 226, 234, 201, 191, 255, 235, 119, 184, 100, 109, 251, 64, 61, 244, 136, 89, 226, 78, 140, 84, 34, 231, 131, 101, 211, 158, 172, 171, 31, 43, 53, 236, 111, 3, 2, 102, 158, 70, 56, 203, 235, 50, 74, 89, 223, 34, 4, 104, 84, 165, 203, 88, 163, 94, 58, 76, 211, 123, 204, 117, 169, 250, 209, 4, 194, 100, 138, 193, 206, 81, 173, 235, 185, 8, 106, 206, 38, 68, 226, 196, 66, 117, 17, 28, 147, 172, 74, 235, 41, 129, 237, 189, 178, 35, 92, 253, 20, 4, 238, 254, 169, 232, 243, 56, 155, 33, 7, 19, 60, 141, 211, 158, 82, 188, 106, 250, 166, 1, 223, 124, 85, 90, 121, 89, 250, 104, 198, 244, 123, 19, 66, 81, 127, 185, 8, 129, 198, 41, 89, 62, 57, 138, 14, 7, 228, 226, 31, 26, 1, 53, 152, 123, 229, 76, 224, 152, 158, 19, 132, 75, 48, 205, 74, 3, 88, 205, 185, 82, 22, 57, 70, 235, 224, 207, 94, 116, 115, 216, 34, 161, 225, 128, 163, 25, 58, 177, 223, 197, 67, 146, 243, 137, 199, 130, 77, 209, 119, 213, 88, 239, 115, 6, 126, 78, 137, 235, 10, 130, 157, 35, 228, 37, 11, 185, 199, 58, 237, 239, 88, 46, 152, 167, 63, 29, 117, ];
        let data = vec![134u8, 69, 116, 85, 92, 21, 249, 94, ]; //, 121, 199, 84, 254, 215, 68, 97, 101, 57, 224, 75, 176, 124, 112, 111, 25, 162, 152, 186, 241, 85, 210, 0, 95, 248, 68, 241, 4, 192, 99, 99, 191, 200, 66, 66, 236, 192, 149, 141, 60, 231, 250, 70, 31, 205, 175, 125, 131, 9, 69, 233, 58, 14, 170, 18, 191, 190, 161, 84, 217, 155, 193, 251, 0, 21, 154, 43, 241, 148, 22, 222, 34, 107, 77, 96, 213, 247, 8, 61, 205, 180, 69, 104, 124, 205, 20, 241, 17, 26, 110, 66, 97, 220, 109, 99, 238, 150, 144, 20, 237, 104, 135, 196, 175, 131, 9, 189, 152, 242, 119, 229, 73, 6, 23, 33, 11, 63, 40, 247, 237, 235, 8, 39, 35, 146, 70, 205, 183, 160, 31, 179, 205, 106, 149, 8, 207, 196, 67, 81, 141, 159, 46, 114, 224, 141, 2, 151, 103, 177, 131, 248, 205, 85, 153, 75, 46, 128, 112, 113, 16, 223, 32, 156, 108, 245, 183, 174, 168, 75, 211, 85, 196, 78, 251, 107, 139, 28, 117, 192, 33, 254, 182, 94, 6, 75, 156, 0, 51, 55, 42, 5, 91, 2, 151, 153, 139, 58, 254, 150, 209, 213, 124, 62, 44, 247, 204, 146, 232, 207, 24, 77, 172, 223, 94, 248, 248, 110, 22, 29, 29, 44, 144, 128, 252, 164, 183, 167, 183, 131, 61, 27, 137, 255, 105, 26, 158, 71, 132, 240, 21, 15, 42, 22, 151, 118, 85, 30, 253, 17, 37, 106, 216, 14, 117, 123, 68, 138, 183, 179, 180, 174, 10, 58, 76, 78, 111, 172, 182, 241, 187, 175, 90, 212, 100, 78, 4, 167, 195, 90, 118, 216, 211, 33, 162, 89, 88, 253, 75, 69, 5, 201, 42, 216, 60, 139, 155, 253, 156, 145, 147, 101, 147, 41, 219, 69, 39, 158, 146, 206, 58, 208, 127, 203, 234, 228, 201, 241, 107, 108, 131, 166, 192, 135, 129, 213, 136, 135, 166, 117, 209, 183, 212, 158, 222, 202, 249, 150, 40, 229, 25, 68, 187, 64, 199, 103, 65, 94, 129, 183, 131, 227, 204, 12, 5, 2, 138, 246, 235, 55, 201, 121, 147, 231, 173, 214, 158, 108, 150, 80, 201, 253, 175, 77, 63, 66, 156, 154, 198, 108, 164, 74, 105, 71, 117, 84, 78, 32, 47, 244, 83, 41, 8, 150, 24, 54, 101, 20, 157, 25, 24, 186, 47, 236, 42, 253, 21, 134, 52, 250, 41, 103, 31, 63, 20, 117, 26, 70, 167, 13, 86, 83, 79, 111, 106, 246, 195, 19, 62, 118, 111, 186, 45, 155, 76, 4, 75, 193, 39, 26, 140, 19, 82, 155, 63, 17, 86, 58, 15, 103, 179, 19, 132, 82, 140, 52, 129, 167, 34, 245, 78, 198, 85, 243, 174, 167, 95, 192, 224, 34, 239, 194, 48, 131, 229, 152, 163, 5, 124, 102, 149, 244, 105, 120, 165, 132, 203, 115, 85, 201, 21, 9, 201, 236, 184, 44, 204, 128, 44, 253, 151, 252, 73, 26, 86, 195, 205, 140, 190, 183, 26, 17, 84, 109, 116, 71, 218, 170, 118, 79, 208, 68, 94, 226, 166, 80, 113, 58, 79, 94, 10, 153, 253, 199, 165, 114, 64, 126, 93, 242, 168, 189, 10, 52, 179, 184, 126, 168, 201, 38, 103, 22, 97, 166, 197, 88, 129, 190, 110, 70, 90, 25, 131, 6, 82, 191, 24, 123, 191, 50, 87, 242, 45, 165, 59, 86, 66, 29, 220, 189, 154, 25, 10, 73, 34, 15, 167, 123, 221, 127, 13, 137, 96, 46, 31, 41, 28, 53, 106, 164, 212, 60, 25, 217, 23, 62, 102, 127, 126, 248, 146, 72, 137, 158, 13, 7, 116, 38, 135, 87, 93, 32, 110, 71, 239, 14, 175, 199, 54, 172, 78, 96, 105, 160, 47, 251, 77, 14, 45, 100, 77, 216, 128, 224, 211, 102, 4, 3, 6, 46, 6, 190, 106, 226, 22, 1, 38, 193, 12, 0, 61, 64, 151, 169, 180, 240, 46, 223, 59, 111, 89, 246, 81, 30, 152, 112, 48, 140, 66, 69, 47, 0, 237, 226, 47, 17, 66, 248, 78, 111, 167, 29, 239, 193, 154, 190, 127, 45, 65, 55, 224, 153, 22, 33, 224, 200, 209, 18, 246, 78, 172, 48, 37, 120, 227, 254, 203, 198, 195, 62, 163, 175, 62, 182, 110, 237, 0, 89, 183, 121, 112, 27, 235, 157, 104, 104, 254, 46, 88, 79, 189, 9, 64, 164, 14, 28, 37, 16, 122, 85, 130, 216, 252, 120, 31, 145, 7, 243, 194, 241, 120, 252, 208, 214, 68, 172, 30, 113, 184, 190, 32, 122, 232, 13, 63, 87, 200, 163, 195, 224, 118, 171, 121, 110, 232, 25, 15, 148, 137, 96, 68, 57, 145, 250, 47, 191, 2, 62, 13, 236, 197, 99, 201, 104, 57, 57, 12, 232, 212, 97, 109, 54, 117, 101, 182, 153, 52, 181, 153, 87, 222, 240, 153, 27, 8, 53, 125, 7, 57, 107, 26, 91, 237, 167, 125, 180, 132, 140, 128, 108, 201, 21, 12, 56, 30, 148, 78, 127, 130, 17, 43, 93, 70, 247, 175, 242, 1, 207, 37, 120, 123, 185, 17, 147, 27, 76, 238, 3, 40, 232, 160, 170, 193, 51, 186, 4, 139, 59, 205, 217, 188, 111, 114, 71, 22, 247, 115, 10, 124, 143, 221, 234, 108, 159, 52, 174, 48, 77, 196, 98, 16, 234, 168, 121, 4, 65, 165, 70, 183, 225, 80, 124, 48, 55, 26, 209, 176, 99, 133, 9, 101, 164, 234, 14, 163, 91, 102, 218, 111, 108, 179, 204, 29, 140, 147, 18, 104, 111, 167, 164, 28, 172, 11, 129, 255, 161, 255, 57, 147, 218, 61, 115, 179, 38, 222, 205, 216, 62, 25, 2, 176, 116, 36, 71, 206, 46, 237, 141, 131, 231, 5, 199, 221, 51, 139, 153, 144, 206, 91, 90, 188, 22, 63, 140, 211, 140, 10, 160, 242, 6, 87, 73, 175, 17, 1, 158, 240, 203, 32, 68, 102, 68, 211, 189, 80, 225, 3, 197, 151, 157, 55, 177, 14, 153, 14, 211, 108, 195, 102, 14, 118, 137, 150, 126, 143, 92, 66, 145, 22, 105, 51, 239, 83, 235, 74, 59, 209, 60, 207, 141, 66, 147, 125, 176, 196, 104, 22, 208, 96, 65, 26, 4, 56, 166, 184, 254, 48, 163, 145, 254, 26, 219, 106, 142, 117, 26, 177, 94, 122, 210, 133, 49, 24, 185, 37, 76, 113, 100, 35, 11, 254, 94, 78, 142, 64, 211, 213, 55, 246, 166, 29, 63, 11, 54, 144, 134, 163, 166, 212, 100, 236, 13, 190, 89, 228, 59, 239, 255, 132, 87, 86, 154, 156, 216, 51, 192, 189, 36, 62, 27, 246, 116, 169, 125, 57, 71, 200, 80, 157, 103, 134, 12, 221, 12, 18, 163, 171, 227, 177, 171, 175, 61, 206, 228, 204, 133, 211, 26, 50, 234, 241, 233, 144, 130, 169, 142, 27, 103, 202, 214, 208, 83, 240, 77, 236, 204, 188, 73, 10, 55, 36, 72, 243, 75, 206, 144, 214, 250, 231, 53, 199, 25, 70, 144, 24, 28, 114, 148, 14, 119, 68, 59, 201, 119, 9, 149, 148, 213, 240, 71, 179, 162, 108, 101, 140, 143, 104, 21, 234, 197, 26, 244, 224, 2, 72, 90, 238, 222, 53, 169, 174, 132, 165, 112, 207, 86, 145, 142, 83, 76, 195, 26, 55, 117, 141, 163, 56, 94, 24, 172, 226, 24, 207, 218, 188, 125, 86, 139, 247, 144, 244, 179, 159, 104, 227, 247, 79, 235, 44, 5, 229, 213, 68, 254, 14, 224, 203, 247, 165, 75, 73, 77, 138, 9, 15, 145, 211, 155, 50, 41, 96, 239, 102, 68, 244, 210, 244, 238, 133, 5, 102, 116, 156, 184, 238, 5, 55, 153, 206, 157, 178, 226, 209, 229, 36, 157, 51, 95, 221, 136, 193, 190, 121, 170, 19, 253, 78, 173, 63, 21, 214, 0, 172, 50, 200, 84, 182, 156, 75, 138, 124, 156, 140, 8, 167, 64, 88, 13, 157, 178, 46, 236, 218, 202, 170, 51, 159, 229, 86, 50, 199, 41, 36, 255, 249, 99, 117, 185, 179, 18, 105, 163, 129, 45, 219, 76, 18, 152, 254, 200, 190, 213, 67, 230, 42, 170, 118, 139, 57, 7, 229, 244, 32, 151, 158, 200, 94, 69, 25, 107, 175, 106, 208, 16, 55, 77, 227, 11, 126, 163, 28, 96, 84, 61, 65, 188, 148, 60, 123, 188, 87, 167, 181, 159, 25, 191, 64, 175, 54, 250, 98, 145, 21, 62, 60, 167, 48, 68, 254, 63, 230, 170, 206, 126, 202, 12, 30, 201, 199, 255, 80, 18, 19, 196, 64, 94, 68, 50, 150, 116, 186, 120, 74, 137, 124, 132, 186, 48, 80, 205, 130, 164, 160, 141, 48, 36, 254, 129, 86, 222, 194, 129, 139, 232, 40, 121, 110, 126, 42, 120, 202, 153, 130, 93, 97, 14, 61, 62, 191, 57, 88, 251, 167, 154, 156, 94, 65, 126, 136, 251, 29, 58, 252, 200, 203, 251, 6, 151, 1, 209, 3, 136, 145, 153, 89, 41, 59, 42, 39, 11, 201, 47, 135, 206, 214, 21, 41, 184, 170, 232, 38, 64, 222, 1, 144, 96, 38, 246, 234, 191, 122, 244, 171, 39, 178, 2, 70, 214, 66, 6, 45, 114, 246, 252, 250, 49, 30, 152, 243, 209, 197, 63, 102, 9, 230, 119, 107, 26, 195, 228, 187, 43, 51, 10, 231, 141, 112, 141, 116, 23, 156, 246, 44, 210, 97, 172, 110, 180, 12, 251, 176, 160, 27, 74, 245, 15, 173, 115, 54, 193, 219, 102, 108, 54, 27, 43, 100, 224, 242, 198, 97, 37, 202, 122, 178, 224, 116, 70, 250, 81, 68, 48, 7, 23, 4, 155, 236, 242, 88, 62, 16, 62, 46, 60, 68, 207, 118, 235, 236, 211, 207, 174, 145, 187, 241, 210, 56, 242, 238, 13, 219, 33, 192, 117, 173, 210, 103, 144, 201, 136, 203, 26, 189, 179, 8, 182, 171, 151, 170, 153, 95, 226, 49, 180, 223, 176, 209, 77, 115, 188, 217, 216, 117, 5, 14, 101, 201, 171, 190, 253, 161, 162, 238, 185, 113, 149, 143, 45, 68, 111, 3, 220, 60, 191, 204, 66, 56, 27, 13, 139, 204, 66, 25, 20, 77, 221, 74, 230, 45, 239, 106, 213, 96, 8, 190, 73, 209, 200, 172, 148, 227, 6, 67, 229, 224, 56, 5, 241, 177, 165, 76, 8, 153, 84, 107, 7, 179, 204, 24, 127, 134, 81, 229, 252, 181, 249, 159, 254, 116, 99, 201, 53, 93, 78, 26, 86, 236, 53, 245, 95, 62, 89, 16, 58, 211, 113, 131, 214, 50, 171, 134, 1, 29, 154, 209, 2, 3, 63, 246, 66, 236, 100, 222, 21, 225, 115, 163, 185, 245, 230, 147, 170, 177, 88, 0, 25, 199, 230, 159, 170, 244, 53, 5, 42, 71, 232, 199, 136, 124, 55, 13, 0, 29, 71, 178, 183, 129, 204, 162, 214, 135, 116, 190, 247, 44, 7, 100, 252, 64, 238, 94, 227, 157, 0, 44, 110, 56, 138, 193, 42, 230, 181, 147, 208, 52, 59, 39, 68, 227, 231, 92, 175, 70, 59, 214, 110, 61, 56, 105, 162, 115, 129, 140, 163, 19, 178, 98, 139, 105, 151, 247, 193, 14, 75, 139, 27, 17, 127, 7, 235, 100, 116, 81, 31, 255, 218, 35, 217, 112, 69, 51, 18, 120, 194, 124, 216, 98, 30, 104, 218, 56, 160, 252, 245, 105, 145, 59, 108, 138, 108, 244, 177, 105, 82, 11, 181, 139, 121, 111, 143, 56, 111, 217, 95, 136, 1, 120, 223, 252, 242, 248, 186, 184, 246, 230, 223, 134, 73, 243, 55, 19, 103, 77, 245, 91, 107, 183, 175, 156, 8, 163, 57, 37, 18, 204, 197, 250, 45, 215, 59, 210, 138, 159, 224, 49, 20, 163, 161, 82, 133, 60, 51, 109, 111, 210, 239, 67, 31, 111, 240, 130, 38, 63, 203, 65, 64, 184, 246, 139, 115, 128, 127, 46, 61, 61, 178, 89, 215, 250, 222, 90, 239, 214, 113, 249, 182, 247, 216, 197, 47, 245, 103, 21, 205, 24, 226, 237, 22, 59, 136, 62, 51, 255, 153, 147, 118, 94, 105, 43, 40, 176, 31, 98, 101, 177, 41, 243, 151, 19, 162, 107, 243, 160, 54, 225, 162, 9, 165, 213, 210, 181, 227, 61, 174, 20, 149, 218, 111, 10, 245, 230, 139, 76, 242, 26, 144, 150, 241, 87, 132, 154, 64, 237, 31, 141, 9, 119, 173, 95, 49, 95, 33, 214, 221, 197, 29, 9, 88, 142, 237, 237, 119, 252, 132, 94, 68, 253, 191, 100, 38, 111, 126, 202, 142, 7, 10, 86, 133, 215, 14, 222, 21, 85, 236, 23, 123, 206, 10, 132, 43, 137, 148, 121, 158, 189, 87, 154, 64, 53, 180, 23, 162, 104, 14, 228, 122, 83, 76, 83, 130, 66, 137, 9, 205, 94, 48, 61, 37, 182, 20, 6, 48, 16, 152, 162, 127, 200, 129, 19, 243, 178, 140, 186, 248, 118, 56, 192, 102, 129, 252, 83, 89, 113, 46, 161, 220, 163, 1, 141, 129, 80, 11, 122, 142, 166, 42, 213, 61, 241, 154, 150, 107, 60, 170, 79, 175, 28, 228, 68, 144, 215, 193, 157, 217, 186, 92, 75, 129, 234, 44, 92, 224, 121, 139, 208, 140, 72, 90, 119, 24, 191, 29, 191, 119, 239, 244, 51, 186, 3, 191, 209, 31, 211, 63, 36, 72, 186, 63, 59, 130, 169, 124, 217, 189, 169, 24, 109, 188, 124, 252, 71, 2, 88, 40, 124, 136, 118, 254, 160, 0, 123, 49, 154, 59, 103, 54, 19, 86, 171, 253, 11, 165, 227, 34, 195, 105, 158, 202, 12, 67, 6, 243, 203, 102, 62, 227, 128, 87, 69, 131, 191, 47, 221, 49, 210, 59, 86, 23, 93, 120, 107, 16, 216, 239, 216, 133, 217, 36, 97, 251, 159, 176, 178, 48, 167, 149, 150, 210, 193, 201, 61, 119, 34, 152, 7, 177, 176, 100, 14, 141, 112, 223, 152, 126, 77, 197, 198, 1, 152, 176, 88, 26, 144, 53, 155, 199, 22, 43, 100, 233, 82, 190, 136, 84, 176, 51, 80, 69, 153, 62, 119, 194, 190, 3, 60, 66, 157, 9, 30, 8, 22, 228, 2, 16, 143, 247, 63, 201, 196, 31, 219, 240, 64, 71, 219, 66, 72, 159, 16, 169, 22, 137, 32, 219, 228, 66, 169, 253, 77, 239, 214, 95, 171, 240, 218, 88, 52, 10, 209, 8, 3, 167, 130, 135, 101, 127, 138, 249, 36, 19, 113, 234, 190, 38, 101, 75, 20, 13, 49, 199, 7, 192, 83, 185, 237, 168, 247, 124, 244, 126, 177, 119, 219, 65, 74, 7, 218, 133, 103, 100, 130, 86, 183, 142, 49, 211, 137, 56, 101, 220, 233, 32, 248, 184, 254, 149, 166, 91, 5, 128, 83, 134, 153, 108, 137, 205, 51, 205, 144, 115, 15, 199, 62, 36, 0, 63, 228, 235, 62, 78, 172, 128, 116, 245, 59, 240, 141, 199, 171, 16, 127, 105, 75, 128, 207, 231, 93, 129, 16, 54, 186, 65, 220, 155, 165, 251, 202, 28, 232, 16, 237, 175, 228, 227, 10, 193, 28, 128, 85, 207, 250, 218, 177, 163, 51, 219, 252, 65, 44, 9, 72, 96, 229, 68, 25, 87, 210, 130, 128, 45, 17, 58, 51, 67, 230, 58, 200, 79, 103, 117, 119, 94, 36, 74, 158, 161, 242, 254, 79, 170, 139, 236, 173, 4, 180, 213, 151, 112, 76, 214, 61, 222, 175, 217, 2, 244, 218, 62, 9, 38, 252, 56, 66, 146, 9, 159, 136, 39, 133, 157, 126, 219, 122, 139, 242, 123, 197, 52, 244, 97, 38, 180, 242, 57, 45, 114, 248, 199, 62, 250, 58, 142, 253, 232, 137, 166, 138, 46, 252, 233, 76, 194, 57, 169, 235, 69, 90, 133, 204, 49, 191, 122, 149, 222, 14, 22, 208, 89, 30, 165, 5, 210, 89, 252, 108, 23, 218, 90, 245, 200, 248, 97, 53, 217, 194, 210, 255, 193, 76, 0, 160, 114, 20, 225, 108, 17, 232, 72, 117, 15, 132, 66, 173, 251, 248, 234, 118, 150, 129, 54, 141, 20, 32, 208, 209, 77, 195, 217, 215, 66, 35, 158, 90, 64, 112, 187, 104, 169, 160, 205, 7, 108, 185, 203, 117, 156, 15, 231, 224, 115, 12, 161, 254, 90, 108, 124, 227, 170, 182, 37, 89, 95, 127, 121, 231, 114, 217, 193, 74, 88, 148, 251, 107, 36, 29, 143, 34, 110, 33, 106, 13, 187, 24, 137, 210, 140, 104, 234, 104, 158, 110, 161, 152, 216, 122, 124, 100, 110, 149, 193, 224, 207, 213, 153, 59, 49, 229, 219, 50, 141, 113, 144, 197, 120, 187, 170, 102, 167, 203, 2, 223, 165, 172, 4, 100, 114, 189, 141, 76, 206, 28, 115, 86, 246, 211, 25, 135, 221, 76, 190, 60, 68, 68, 247, 145, 78, 18, 183, 237, 76, 16, 152, 201, 175, 91, 117, 55, 53, 229, 8, 148, 117, 22, 70, 185, 78, 3, 211, 171, 198, 206, 85, 134, 204, 76, 56, 103, 38, 32, 252, 222, 106, 46, 43, 223, 8, 170, 142, 253, 202, 101, 120, 217, 199, 175, 192, 199, 216, 21, 82, 239, 108, 75, 25, 221, 188, 202, 178, 233, 216, 24, 107, 216, 127, 12, 129, 5, 234, 90, 180, 156, 6, 119, 169, 5, 9, 144, 29, 216, 38, 102, 198, 176, 138, 59, 1, 231, 231, 80, 91, 156, 255, 113, 244, 163, 230, 96, 34, 221, 7, 242, 40, 153, 249, 164, 231, 149, 223, 49, 239, 11, 167, 241, 41, 229, 89, 62, 206, 10, 141, 15, 86, 45, 3, 96, 234, 172, 36, 141, 161, 123, 238, 38, 224, 219, 22, 98, 52, 187, 28, 33, 66, 209, 3, 1, 21, 235, 68, 165, 52, 122, 168, 51, 188, 118, 73, 192, 120, 5, 226, 126, 237, 6, 48, 180, 62, 46, 157, 45, 102, 84, 141, 174, 195, 182, 198, 244, 244, 71, 111, 38, 241, 119, 188, 228, 242, 135, 235, 222, 124, 78, 27, 239, 55, 184, 87, 104, 20, 225, 4, 106, 237, 173, 138, 63, 202, 132, 33, 146, 58, 12, 209, 1, 90, 249, 26, 97, 98, 221, 79, 127, 180, 235, 38, 230, 30, 163, 145, 99, 242, 151, 26, 123, 80, 127, 242, 138, 254, 63, 217, 50, 249, 206, 64, 117, 111, 145, 100, 217, 102, 179, 44, 104, 129, 140, 76, 143, 94, 103, 181, 232, 197, 185, 128, 109, 45, 121, 106, 223, 75, 21, 8, 201, 204, 149, 204, 92, 78, 26, 88, 193, 26, 205, 60, 4, 82, 26, 201, 254, 162, 238, 166, 95, 137, 78, 49, 162, 88, 192, 117, 0, 25, 215, 20, 113, 66, 222, 165, 206, 172, 189, 203, 213, 102, 174, 191, 79, 145, 125, 249, 81, 205, 63, 108, 117, 129, 98, 2, 87, 152, 250, 185, 11, 139, 157, 186, 79, 201, 26, 196, 120, 213, 179, 108, 186, 230, 55, 94, 73, 208, 209, 58, 28, 238, 255, 118, 0, 118, 223, 139, 208, 1, 166, 238, 146, 79, 222, 138, 8, 9, 88, 60, 16, 232, 253, 15, 83, 14, 55, 84, 182, 137, 246, 48, 195, 109, 20, 100, 224, 112, 182, 47, 153, 48, 37, 60, 7, 86, 188, 106, 12, 223, 123, 126, 183, 90, 156, 159, 214, 140, 124, 215, 135, 252, 42, 238, 86, 49, 25, 10, 106, 240, 132, 224, 48, 249, 125, 43, 154, 178, 148, 84, 52, 247, 154, 215, 215, 98, 253, 189, 57, 200, 27, 163, 241, 231, 79, 67, 3, 164, 0, 48, 186, 178, 157, 49, 23, 191, 104, 156, 100, 102, 0, 40, 10, 113, 5, 42, 152, 224, 184, 97, 171, 50, 127, 217, 162, 148, 19, 171, 105, 42, 145, 45, 138, 230, 214, 96, 35, 198, 117, 0, 140, 45, 22, 140, 15, 245, 22, 153, 90, 23, 139, 153, 224, 65, 187, 155, 108, 49, 203, 185, 114, 1, 72, 5, 175, 53, 53, 93, 237, 25, 181, 28, 212, 185, 157, 88, 39, 42, 213, 121, 76, 24, 70, 249, 203, 140, 149, 230, 220, 26, 180, 0, 56, 158, 175, 219, ];
        let mut delta_chunk = Vec::new();
        for byte in 2u32.to_be_bytes() {
            delta_chunk.push(byte);
        }
        for delta_action in
            levenshtein_functions::encode(data.as_slice(), parent_chunk_data.as_slice())
        {
            for byte in delta_action.to_be_bytes() {
                delta_chunk.push(byte);
            }
        }

        let mut buf = [0u8; 4];
        buf.copy_from_slice(&delta_chunk[..4]);

        let parent_hash = u32::from_be_bytes(buf);
        let mut data_recovery = parent_chunk_data.clone();

        let mut byte_index = 4;
        while byte_index < delta_chunk.len() {
            buf.copy_from_slice(&delta_chunk[byte_index..byte_index + 4]);
            let delta_action = u32::from_be_bytes(buf);

            let (action, index, byte_value) = get_delta_action(delta_action);
            match action {
                Action::Del => {
                    data_recovery.remove(index);
                }
                Action::Add => {
                    data_recovery.insert(index, byte_value);
                }
                Action::Rep => {
                    data_recovery[index] = byte_value;
                }
            }
            byte_index += 4;
        }

        assert_eq!(data_recovery, data);
    }

    fn get_delta_action(code: u32) -> (Action, usize, u8) {
        let action = match code / (1 << 30) {
            0 => Action::Rep,
            1 => Action::Add,
            2 => Action::Del,
            _ => panic!(),
        };
        let byte_value = code % (1 << 30) / (1 << 22);
        let index = code % (1 << 22);
        (action, index as usize, byte_value as u8)
    }


}
